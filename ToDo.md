# CRM 3.0 - –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è

## üìã –¢–ï–ö–£–©–ê–Ø –ó–ê–î–ê–ß–ê: –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

**–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è:**
- –†–æ–ª–∏: Admin, Seller (–ü—Ä–æ–¥–∞–≤–µ—Ü), Executor (–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å) - –∫–æ–º–±–∏–Ω–∏—Ä—É—é—Ç—Å—è
- –í–∏–¥–∏–º–æ—Å—Ç—å: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ (–≥–¥–µ –æ–Ω seller –∏–ª–∏ executor) ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –¢–æ–ª—å–∫–æ Admin –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —á—É–∂–∏–µ –¥–∞–Ω–Ω—ã–µ ‚Üê –¢–ï–ö–£–©–ê–Ø –§–ê–ó–ê
- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –Ω–∞ –≤—Å–µ—Ö endpoints (–∫—Ä–æ–º–µ /auth/login/) ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û
- –ü—Ä–æ–µ–∫—Ç: 3-5 —á–µ–ª–æ–≤–µ–∫, –ø—É–±–ª–∏—á–Ω–æ—Å—Ç—å –Ω–µ –Ω—É–∂–Ω–∞

---

## ‚úÖ –§–ê–ó–ê 1-2: –ó–ê–í–ï–†–®–ï–ù–ê (Commit 88376a4)

‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–æ–ª–µ–π –≤ –ë–î (Admin, Seller, Executor)
‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∫–ª–∞—Å—Å–æ–≤ permissions
‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ IsAuthenticated –∫–æ –≤—Å–µ–º ViewSets
‚úÖ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ DEFAULT_PERMISSION_CLASSES –Ω–∞ IsAuthenticated
‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å—Å—ã–ª–æ–∫ –Ω–∞ —Ä–æ–ª–∏ —Å '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' –Ω–∞ 'Admin'

---

## üü† –§–ê–ó–ê 4: –ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Ç–æ–ª—å–∫–æ Admin)

### –≠—Ç–∞–ø 4.1: –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Ç–æ–¥—ã update/partial_update
- [ ] –í –∫–∞–∂–¥–æ–º ViewSet –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
  ```python
  def update(self, request, *args, **kwargs):
      # –¢–æ–ª—å–∫–æ Admin –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
      if not request.user.user_roles.filter(role__name='Admin').exists():
          return Response(
              {'detail': '–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ'},
              status=status.HTTP_403_FORBIDDEN
          )
      return super().update(request, *args, **kwargs)
  ```
- [ ] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ –≤—Å–µ–º ViewSets (Deal, Client, Task, Payment, Policy, Document, Note)

### –≠—Ç–∞–ø 4.2: –ö–æ–Ω—Ç—Ä–æ–ª—å —É–¥–∞–ª–µ–Ω–∏—è (destroy)
- [ ] –ü–æ–∫–∞ –Ω–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π (–∫–∞–∫ —Å–∫–∞–∑–∞–Ω–æ –≤ —Å–ø–µ—Ü–µ), –Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ Admin –ø–æ–∑–∂–µ

---

## üü° –§–ê–ó–ê 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è

### –≠—Ç–∞–ø 5.1: –ú–æ–¥—É–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `backend/tests/test_permissions.py` —Å —Ç–µ—Å—Ç–∞–º–∏:
  - –¢–µ—Å—Ç 1: –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç 401 –Ω–∞ protected endpoint
  - –¢–µ—Å—Ç 2: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–¥–µ–ª–∫–∏
  - –¢–µ—Å—Ç 3: Admin –≤–∏–¥–∏—Ç –≤—Å–µ —Å–¥–µ–ª–∫–∏
  - –¢–µ—Å—Ç 4: –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (403)
  - –¢–µ—Å—Ç 5: Admin –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ª—é–±—ã–µ –¥–∞–Ω–Ω—ã–µ
- [ ] –í—ã–ø–æ–ª–Ω–∏—Ç—å: `docker-compose exec backend python -m pytest tests/test_permissions.py -v`

### –≠—Ç–∞–ø 5.2: –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ Django admin:
  - User 1: Seller (–ø—Ä–æ–¥–∞–≤–µ—Ü)
  - User 2: Executor (–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å)
  - User 3: Admin
- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–¥–µ–ª–∫–∏ (User1 = seller, User2 = executor)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å curl/Postman:
  ```bash
  # –õ–æ–≥–∏–Ω User1
  curl -X POST http://127.0.0.1:8000/api/v1/auth/login/ \
    -H "Content-Type: application/json" \
    -d '{"username":"user1","password":"pass1"}'

  # –ü–æ–ª—É—á–∏—Ç—å —Å–≤–æ–∏ —Å–¥–µ–ª–∫–∏ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 1)
  curl -H "Authorization: Bearer <token>" \
    http://127.0.0.1:8000/api/v1/deals/

  # –ü–æ–ø—ã—Ç–∞—Ç—å—Å—è –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞ 403)
  curl -X PATCH http://127.0.0.1:8000/api/v1/deals/{id}/ \
    -H "Authorization: Bearer <token>" \
    -H "Content-Type: application/json" \
    -d '{"title":"New title"}'
  ```

### –≠—Ç–∞–ø 5.3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: `docker-compose up -d`
- [ ] –í–æ–π—Ç–∏ –≤ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∫–∞–∫ —Ä–∞–∑–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∫–∞–∂–¥—ã–π –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ–ø—ã—Ç–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á—É–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ dev tools –≤—ã–¥–∞—ë—Ç –æ—à–∏–±–∫—É

---

## üü¢ –§–ê–ó–ê 6: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –≠—Ç–∞–ø 6.1: –û–±–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- [ ] API –∫–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –ª–æ–≤–∏—Ç—å 401/403 –æ—à–∏–±–∫–∏ –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞ –ª–æ–≥–∏–Ω
- [ ] –§–∞–π–ª: `frontend/src/api.ts`
  ```typescript
  if (response.status === 401 || response.status === 403) {
      // –û—á–∏—Å—Ç–∏—Ç—å —Ç–æ–∫–µ–Ω—ã –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ª–æ–≥–∏–Ω
      clearTokens();
      window.location.href = '/';
  }
  ```

### –≠—Ç–∞–ø 6.2: –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –¥–æ—Å—Ç—É–ø–∞
- [ ] –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —á—É–∂–∏–µ –¥–∞–Ω–Ω—ã–µ, –ø–æ–∫–∞–∑–∞—Ç—å: "–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ"

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

- [ ] –í—Å–µ endpoints —Ç—Ä–µ–±—É—é—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–∫—Ä–æ–º–µ /auth/login, /auth/refresh, /auth/me)
- [ ] –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
- [ ] –¢–æ–ª—å–∫–æ Admin –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å/—É–¥–∞–ª—è—Ç—å
- [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- [ ] –§—Ä–æ–Ω—Ç–µ–Ω–¥ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –¥–æ—Å—Ç—É–ø–∞
- [ ] –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö –∫–æ–¥

---

## üéØ –ë—É–¥—É—â–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç üî¥ –í–´–°–û–ö–ê–Ø:**
- ‚è≥ –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≤—Å–µ–º –ø–æ–ª—è–º
- ‚è≥ –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç üü° –°–†–ï–î–ù–Ø–Ø:**
- ‚è≥ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- ‚è≥ –£–ª—É—á—à–µ–Ω–∏–µ UI –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
