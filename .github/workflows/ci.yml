name: CI - Code Quality & Tests

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master, develop]

jobs:
  secret-scan:
    name: Secret Scan (changed files)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install detect-secrets
        run: |
          python -m pip install --upgrade pip
          pip install detect-secrets==1.5.0

      - name: Scan changed files for secrets
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            base_ref="${{ github.base_ref }}"
            git fetch origin "${base_ref}" --depth=1
            mapfile -t changed_files < <(git diff --name-only --diff-filter=ACMRT "origin/${base_ref}...HEAD")
          else
            before_sha="${{ github.event.before }}"
            if [ -z "${before_sha}" ] || [ "${before_sha}" = "0000000000000000000000000000000000000000" ]; then
              mapfile -t changed_files < <(git show --name-only --pretty='' --diff-filter=ACMRT "${{ github.sha }}")
            else
              mapfile -t changed_files < <(git diff --name-only --diff-filter=ACMRT "${before_sha}...${{ github.sha }}")
            fi
          fi

          if [ "${#changed_files[@]}" -eq 0 ]; then
            echo "No changed files to scan."
            exit 0
          fi

          scan_files=()
          for file in "${changed_files[@]}"; do
            if [ -f "${file}" ]; then
              case "${file}" in
                mailcow/*|frontend/package-lock.json)
                  continue
                  ;;
              esac
              scan_files+=("${file}")
            fi
          done

          if [ "${#scan_files[@]}" -eq 0 ]; then
            echo "No eligible changed files for secret scan."
            exit 0
          fi

          detect-secrets-hook "${scan_files[@]}"

  backend-lint:
    name: Backend Linting
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install black isort ruff

      - name: Run Black (formatting check)
        run: black --check backend/

      - name: Run isort (import sorting)
        run: isort --check-only backend/

      - name: Run Ruff (linting)
        run: ruff check backend/

  backend-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: crm3_test
          POSTGRES_USER: crm3
          POSTGRES_PASSWORD: crm3 # pragma: allowlist secret
        options: >-
          --health-cmd "pg_isready -U crm3 -d crm3_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pytest pytest-django pytest-cov

      - name: Restore Google Drive credentials
        env:
          GOOGLE_DRIVE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_DRIVE_SERVICE_ACCOUNT_JSON }}
        run: |
          echo "$GOOGLE_DRIVE_SERVICE_ACCOUNT_JSON" > "$RUNNER_TEMP/drive-sa.json"
          chmod 600 "$RUNNER_TEMP/drive-sa.json"

      - name: Run migrations
        env:
          DEBUG: 'False'
          DJANGO_DB_ENGINE: django.db.backends.postgresql
          DJANGO_DB_HOST: localhost
          DJANGO_DB_PORT: '5432'
          DJANGO_DB_NAME: crm3_test
          DJANGO_DB_USER: crm3
          DJANGO_DB_PASSWORD: crm3
          DJANGO_SECRET_KEY: test-secret-key # pragma: allowlist secret
          ALLOWED_HOSTS: localhost,127.0.0.1
          CORS_ALLOWED_ORIGINS: http://localhost:3000,http://127.0.0.1:3000
          GOOGLE_DRIVE_ROOT_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_ROOT_FOLDER_ID }}
          GOOGLE_DRIVE_SERVICE_ACCOUNT_FILE: ${{ runner.temp }}/drive-sa.json
        run: |
          cd backend
          python manage.py migrate --no-input

      - name: Run tests
        env:
          DEBUG: 'False'
          DJANGO_DB_ENGINE: django.db.backends.postgresql
          DJANGO_DB_HOST: localhost
          DJANGO_DB_PORT: '5432'
          DJANGO_DB_NAME: crm3_test
          DJANGO_DB_USER: crm3
          DJANGO_DB_PASSWORD: crm3
          DJANGO_SECRET_KEY: test-secret-key # pragma: allowlist secret
          ALLOWED_HOSTS: localhost,127.0.0.1
          CORS_ALLOWED_ORIGINS: http://localhost:3000,http://127.0.0.1:3000
          GOOGLE_DRIVE_ROOT_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_ROOT_FOLDER_ID }}
          GOOGLE_DRIVE_SERVICE_ACCOUNT_FILE: ${{ runner.temp }}/drive-sa.json
        run: |
          cd backend
          pytest -v --cov=. --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./backend/coverage.xml
          flags: backend
        continue-on-error: true

  frontend-lint:
    name: Frontend Linting & Type Checking
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run ESLint
        run: |
          cd frontend
          npm run lint

      - name: Run Prettier (format check)
        run: |
          cd frontend
          npm run format:check

      - name: Check TypeScript
        run: |
          cd frontend
          npx tsc --noEmit

      - name: Run frontend unit tests
        run: |
          cd frontend
          npm run test

  frontend-build:
    name: Frontend Build Test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Build project
        run: |
          cd frontend
          npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/

  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [secret-scan, backend-lint, backend-tests, frontend-lint, frontend-build]

    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build backend image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./backend/Dockerfile
          push: false
          tags: crm30-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build frontend image
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: false
          tags: crm30-frontend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [secret-scan, backend-lint, backend-tests, frontend-lint, frontend-build, docker-build]
    if: always()

    steps:
      - name: Check workflow status
        run: |
          if [ "${{ needs.backend-lint.result }}" == "failure" ]; then
            echo "Backend lint failed"
            exit 1
          fi
          if [ "${{ needs.secret-scan.result }}" == "failure" ]; then
            echo "Secret scan failed"
            exit 1
          fi
          if [ "${{ needs.backend-tests.result }}" == "failure" ]; then
            echo "Backend tests failed"
            exit 1
          fi
          if [ "${{ needs.frontend-lint.result }}" == "failure" ]; then
            echo "Frontend lint failed"
            exit 1
          fi
          if [ "${{ needs.frontend-build.result }}" == "failure" ]; then
            echo "Frontend build failed"
            exit 1
          fi
          if [ "${{ needs.docker-build.result }}" == "failure" ]; then
            echo "Docker build failed"
            exit 1
          fi
          echo "All quality checks passed!"
